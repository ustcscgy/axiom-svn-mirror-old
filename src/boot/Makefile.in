OUT=${OBJ}/${SYS}/boot
DOC=${MNT}/${SYS}/doc/src/boot
 
LISPSYS= ${OBJ}/${SYS}/bin/lisp
BOOTSYS= ${OBJ}/${SYS}/bin/bootsys
LOADSYS= ${OBJ}/${SYS}/bin/lisp
SAVESYS= ${OBJ}/${SYS}/bin/bootsys

OBJS1=	"${OUT}/boothdr.$(OBJEXT)" "${OUT}/exports.$(OBJEXT)" \
	"${OUT}/npextras.$(OBJEXT)" "${OUT}/ptyout.$(OBJEXT)" \
	"${OUT}/btincl2.$(OBJEXT)" "${OUT}/btscan2.$(OBJEXT)" \
	"${OUT}/typrops.$(OBJEXT)" "${OUT}/btpile2.$(OBJEXT)" \
	"${OUT}/typars.$(OBJEXT)" "${OUT}/tyextra.$(OBJEXT)" \
	"${OUT}/tytree1.$(OBJEXT)"
OBJS=	${OUT}/boothdr.$(OBJEXT) ${OUT}/exports.$(OBJEXT) \
	${OUT}/npextras.$(OBJEXT) ${OUT}/ptyout.$(OBJEXT) \
	${OUT}/btincl2.$(OBJEXT) ${OUT}/btscan2.$(OBJEXT) \
	${OUT}/typrops.$(OBJEXT) ${OUT}/btpile2.$(OBJEXT) \
	${OUT}/typars.$(OBJEXT) ${OUT}/tyextra.$(OBJEXT) \
	${OUT}/tytree1.$(OBJEXT)
 
BOOTS=ptyout.boot btincl2.boot typrops.boot btpile2.boot \
      typars.boot tyextra.boot trtree1.boot
PROCLAIMS=(load "$(srcdir)/boot-proclaims.lisp")

DEPS=   (load (quote $(patsubst %, "%", $(builddir)/npextras.lisp)))

CMD0=	(progn (mapcar (function (lambda (x) (load  x))) (quote (${OBJS1}))) (system::save-system "${SAVESYS}"))
 
DOCFILES=${DOC}/boothdr.lisp.dvi ${DOC}/btincl2.boot.dvi \
         ${DOC}/btpile2.boot.dvi ${DOC}/btscan2.boot.dvi \
         ${DOC}/exports.lisp.dvi ${DOC}/npextras.lisp.dvi \
         ${DOC}/ptyout.boot.dvi ${DOC}/tyextra.boot.dvi \
         ${DOC}/typars.boot.dvi ${DOC}/typrops.boot.dvi \
         ${DOC}/tytree1.boot.dvi


LISP_COMPILE = echo '(progn $(PROCLAIMS) \
			    (compile-file "$<" :output-file "$@") \
			    ($(BYE)))' | $(LISPSYS)

LISP_COMPILE_WITH_DEPS = echo '(progn $(PROCLAIMS) $(DEPS) \
				      (compile-file "$<" :output-file "$@") \
				      ($(BYE)))' | $(LISPSYS)

BOOT_TO_LISP = echo '(progn (boottran::boottocl "$@") ($(BYE)))' \
		| $(BOOTSYS)

 
# this stanza will create the final bootsys image
 
${SAVESYS}:	${OBJS} ${LOADSYS} ${DOCFILES}
	@ echo 44 invoking make in `pwd` with parms:
	@ echo SYS= ${SYS} 
	@ echo LSP= ${LSP} 
	@ echo PART= ${PART} 
	@ echo SPAD= ${SPAD} 
	@ echo SRC= ${SRC} 
	@ echo INT= ${INT}
	@ echo OBJ= ${OBJ} 
	@ echo MNT= ${MNT}
	@ (cd ${OBJ}/${SYS}/bin ; echo '${CMD0}' | ${LOADSYS} >${TMP}/console )
	@ echo 45 ${SAVESYS} created

boot: ${BOOTS}

.PRECIOUS: $(OUT)/%.$(OBJEXT)
.PRECIOUS: $(builddir)/%.lisp

OBJECTS_WITHOUT_DEPS = \
	$(OUT)/boothdr.$(OBJEXT) \
	$(OUT)/exports.$(OBJEXT) \
	$(OUT)/npextras.$(OBJEXT)

$(OBJECTS_WITHOUT_DEPS): $(OUT)/%.$(OBJEXT): $(builddir)/%.lisp
	$(LISP_COMPILE)

$(builddir)/%.lisp: $(srcdir)/%.lisp.pamphlet
	$(axiom_build_document) --tangle $<
.PRECIOUS: $(OUT)/%.$(OBJEXT)
.PRECIOUS: $(builddir)/%.lisp

OBJECTS_WITH_DEPS = \
	$(OUT)/btincl2.$(OBJEXT) \
	$(OUT)/btpile2.$(OBJEXT) \
	$(OUT)/btscan2.$(OBJEXT) \
	$(OUT)/ptyout.$(OBJEXT) \
	$(OUT)/tyextra.$(OBJEXT) \
	$(OUT)/typars.$(OBJEXT) \
	$(OUT)/typrops.$(OBJEXT) \
	$(OUT)/tytree1.$(OBJEXT) 

$(OBJECTS_WITH_DEPS): $(OUT)/%.$(OBJEXT): $(builddir)/%.lisp
	$(LISP_COMPILE_WITH_DEPS)

$(builddir)/%.lisp: $(srcdir)/%.boot.pamphlet
	$(axiom_build_document) --tangle=$*.clisp --output=$*.lisp $<
.PRECIOUS: $(builddir)/%.boot

$(builddir)/%.boot: $(srcdir)/%.boot.pamphlet
	$(axiom_build_document) --tangle $< && \
	$(BOOT_TO_LISP)

document: ${DOCFILES}
	@ echo 42 making tex and dvi files in ${DOC}

.PRECIOUS: $(DOC)/%.dvi
.PRECIOUS: $(builddir)/%.tex
.PRECIOUS: $(builddir)/%.dvi

$(DOC)/%.dvi: $(builddir)/%.dvi
	$(INSTALL) $< $@

$(builddir)/%.dvi: $(axiom_build_texdir)/axiom.sty

$(builddir)/%.dvi: $(builddir)/%.tex
	$(axiom_build_document) --latex $< $(SINK_NOISE)

$(builddir)/%.tex: $(srcdir)/%.pamphlet
	$(axiom_build_document) --weave $<
clean:
	@echo 43 cleaning ${OUT}
	@rm -rf ${OUT}
	rm -f $(builddir)/*.log $(builddir)/*.aux

distclean: clean
	rm -f $(builddir)/*.dvi $(builddir)/*.tex
	rm -f $(builddir)/*.boot $(builddir)/*.lisp
	rm -rf $(DOC)
