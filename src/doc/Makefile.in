IN=$(axiom_src_srcdir)/doc
# MID=${INT}/doc
MID=.
OUT=$(axiom_target_bindir)
STY=${OUT}/tex
DVI=$(axiom_target_docdir)

subdir = src/doc/

#  Temporarly disabled:
#  axiom.bib.pamphlet
pamphlets = \
	DeveloperNotes.pamphlet \
	Rosetta.pamphlet \
	$(booklet_SOURCES)

FILES= ${DVI}/book.dvi ${DVI}/bookvol1.dvi ${DVI}/endpaper.dvi

CMDS=$(axiom_target_bindir)/booklet

.PHONY: all all-doc
all: all-ax

all-ax all-doc: stamp
	@echo 9 finished $(builddir)

stamp: ${CMDS}
	-rm -f stamp
	$(STAMP) stamp

dvi-ax: $(FILES)

.PRECIOUS: %.c
.PRECIOUS: %.o

booklet_sources = booklet.c

booklet_SOURCES = $(addsuffix .pamphlet, $(booklet_sources))

booklet_objects = $(booklet_sources:.c=.$(OBJEXT))

$(axiom_target_bindir)/booklet: $(booklet_objects)
	${CC} $(booklet_objects) -o $@

%.o: %.c
	${CC} -o $@ -c $<

%.c: $(srcdir)/%.c.pamphlet
	$(axiom_build_document) --tangle --output=$@ $<
axiom.bib: $(srcdir)/axiom.bib.pamphlet
	$(axiom_build_document) --tangle --output=$@ $<
${STY}/axiom.sty: $(srcdir)/axiom.sty.pamphlet ${STY}
	$(axiom_build_document) --tangle=axiom.sty --output=$@ $<

${STY}:
	mkdir -p ${STY}

${DVI}/ps ${MID}/ps: $(srcdir)/ps
	-mkdir -p $@
	cp -p $</* $@

${DVI}/book.dvi: $(srcdir)/book.pamphlet ${MID}/ps ${DVI}/ps
	@echo 4 making ${DVI}/book.dvi from ${IN}/book.pamphlet
	-cp ${IN}/book.pamphlet ${MID}
	latex book.pamphlet --interaction nonstopmode && \
	  latex book.pamphlet --interaction nonstopmode 
	cp book.dvi ${DVI}

${DVI}/bookvol1.dvi: $(srcdir)/bookvol1.pamphlet ${MID}/ps ${DVI}/ps
	@echo 4 making ${DVI}/bookvol1.dvi from ${IN}/bookvol1.pamphlet
	(cd ${MID} ; \
	${WEAVE} -t8 -delay ${IN}/bookvol1.pamphlet >bookvol1.tex ; \
	TEXINPUTS=".:$(axiom_build_texdir):$${TEXINPUTS}"; \
	BIBINPUTS=".:$(axiom_build_texdir):$${TEXINPUTS}"; \
	export TEXINPUTS BIBINPUTS; \
	$(axiom_build_document) --latex --index bookvol1.tex ;\
	cp bookvol1.dvi ${DVI})
${DVI}/endpaper.dvi: $(srcdir)/endpaper.pamphlet
	@echo 4 making ${DVI}/endpaper.dvi from ${IN}/endpaper.pamphlet
	${MAKE} ${MID}/ps ${DVI}/ps
	@(cd ${MID} ; \
	cp ${IN}/endpaper.pamphlet ${MID} ; \
	latex endpaper.pamphlet --interaction nonstopmode && \
	  latex endpaper.pamphlet --interaction nonstopmode ; \
	cp endpaper.dvi ${DVI})


mostlyclean-local:
	-rm -f $(booklet_objects)

clean-local: mostlyclean-local
	-rm -f $(axiom_target_bindir)/booklet
	-rm -f $(booklet_sources)

distclean-local: clean-local
