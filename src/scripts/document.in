#!/bin/sh

# usage:
#    document --latex file
#    document --weave file.pamphlet
#    document --weave --latex file.pamphlet
#    document --tangle file.pamphlet
#    document --tangle=chunk --output=fileout filein.pamphlet
#   [ plus any legacy usage ]


# set -x

latex=@LATEX@
index=@MAKINDEX@

tangle=@NOTANGLE@
weave=@NOWEAVE@

TEXINPUTS=.:@axiom_builddir@/share/texmf/tex:$TEXINPUTS
export TEXINPUTS
BIBINPUTS=.:@axiom_builddir@/share/texmf/tex:$BIBINPUTS
export BIBINPUTS


do_index=
do_latex=
do_tangle=
do_weave=
chunk=
file=
output=

while : ; do
    case $1 in
	--weave)
	   do_weave=yes
	   shift
	   ;;

        --latex)
	   do_latex=yes
	   shift
           ;;

        --index)
	   do_index=yes
	   # FIXME: --index may be used only with --latex.  Check.
	   shift
           ;;

	--tangle=*)
	   do_tangle=yes
	   chunk=`echo $1 | awk -F'=' '{ print $2; }'`
	   shift
	   ;;

	--tangle)
	   do_tangle=yes
	   # --tangle may not be combined with any other
	   # options.  FIXME:  Check that. 
	   shift
	   ;;

	--output=*)
	   output=`echo $1 | awk -F'=' '{ print $2; }'`
	   shift
	   ;;

	--*)
	   echo unrecognized option $1
	   exit 1
	   ;;

        *) break ;;
    esac
done

if test x$do_tangle = xyes; then
    # FIXME: Check that the input file name does indeed have
    # a pamphlet extension.
    file=$1
    if [ -z $output ]; then
	output=`basename $file .pamphlet`;
    fi

    # FIXME: Ideally, we should just prepend -R to $chunk
    #        if it is non-null, and say $tangle $chunk $file > $output
    #        Alternatively, we could initialize chunk to '*' and
    #        unconditionally use -R"$chunk".
    if [ -z "$chunk" ]; then
	$tangle $file > $output
    else
	$tangle -R"$chunk" $file > $output
    fi
    # FIXME: Handle errors.
    exit $?;
fi


if test x$do_weave = xyes; then
    file=`basename $1 .pamphlet`
    $weave -delay $1 > $file.tex
    if test x$do_latex != xyes; then
	exit 0;
    fi
fi

if test x$do_latex = xyes; then
    if [ -z $file ]; then
	file=`basename $1 .tex`
    fi
    $latex --interaction nonstopmode $file;
    if [ x$do_index = xyes ]; then
	$makeindex $file.idx
    fi
    $latex --interaction nonstopmode $file;
    exit $?
fi


if [ "$#" = "3" ]; then
 REDIRECT=$2
 FILE=`basename $3 .pamphlet`
 $tangle -t8 $FILE.pamphlet >$FILE
 $weave -delay $FILE.pamphlet >$FILE.tex
 $latex --interaction nonstopmode $FILE.tex >$REDIRECT
 $latex --interaction nonstopmode $FILE.tex >$REDIRECT
 rm -f $FILE~
 rm -f $FILE.pamphlet~
 rm -f $FILE.log
 rm -f $FILE.tex
 rm -f $FILE.toc
 rm -f $FILE.aux
 exit 0
fi
if [ "$#" = "1" ]; then
 FILE=`basename $1 .pamphlet`
 $tangle -t8 $FILE.pamphlet >$FILE
 $weave -delay $FILE.pamphlet >$FILE.tex
 $latex $FILE.tex 
 $latex $FILE.tex
 rm -f $FILE~
 rm -f $FILE.pamphlet~
 rm -f $FILE.log
 rm -f $FILE.tex
 rm -f $FILE.toc
 rm -f $FILE.aux
 exit 0
fi
echo "document [ -o redirect ] pamphlet"

# set +x

