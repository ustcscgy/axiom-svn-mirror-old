
## ----------------------------------------
## -- Old-style Axiom makefile variables --
## ----------------------------------------

VERSION="Axiom (build improvements branch) -- 2006-09-27"
SPD=$(shell pwd)
SPAD=$(axiom_targetdir)
LSP=${SPD}/lsp
SRC=${SPD}/src
INT=${SPD}/int
OBJ=${SPD}/obj
ZIPS=${SPD}/zips
TMP=${OBJ}/tmp
SPADBIN=$(axiom_target_bindir)
INC=${SPD}/src/include
CCLBASE=${OBJ}/${SYS}/ccl/ccllisp
DESTDIR=$(prefix)/axiom
COMMAND=${DESTDIR}/target/$(target)/bin/axiom
NOISE="-o ${TMP}/trace"

PLF=@PLF@
CCF=@CCF@
LDF=@LDF@
LISP=@LISP@
GCLOPTS=@GCLOPTS@

pamphlets = configure.ac.pamphlet Makefile.pamphlet

PART=	cprogs
SUBPART= everything


ENV= SPAD=${SPAD} SPD=${SPD} LSP=${LSP} GCLDIR=${GCLDIR} \
     SRC=${SRC} INT=${INT} OBJ=${OBJ} ZIPS=${ZIPS} TMP=${TMP} \
     SPADBIN=${SPADBIN} INC=${INC} CCLBASE=${CCLBASE} PART=${PART} \
     SUBPART=${SUBPART} NOISE=${NOISE} \
     TANGLE=${TANGLE} VERSION=${VERSION} \
     DOCUMENT=${axiom_build_document} \
     WEAVE=${WEAVE} \
     PLF="$(PLF)" CCF="$(CCF)" LDF="$(LDF)" LISP=$(LISP) \
	GCLOPTS="$(GCLOPTS)"


subdir = 

build_libdir = $(builddir)/src/lib
lib_stamp = $(build_libdir)/stamp

build_lspdir = $(builddir)/lsp
lsp_stamp = $(build_lspdir)/stamp

build_srcdir = $(builddir)/src
src_stamp = $(build_srcdir)/stamp


.PHONY: all
all: @axiom_required_build_utils@ $(axiom_build_document)
	@ echo 1 making a ${SYS} system, PART=${PART} SUBPART=${SUBPART}
	@ echo 2 Environment ${ENV}
	@ $(MAKE) stamp-rootdirs
	@ ${ENV} $(MAKE) $(src_stamp)
	@echo 3 finished system build on `date` | tee >lastBuildDate

book:
	@ echo 79 building the book as $(axiom_target_docdir)/book.dvi 
	@ mkdir -p ${TMP}
	@ mkdir -p $(axiom_target_docdir)
	@ $(INSTALL) ${SRC}/doc/book.pamphlet $(axiom_target_docdir)
	@ cp -pr ${SRC}/doc/ps $(axiom_target_docdir)
	@ (cd $(axiom_target_docdir) ; \
          if [ .${NOISE} = . ] ; then \
	    ( latex book.pamphlet --interaction nonstopmode ; \
	      latex book.pamphlet --interaction nonstopmode ) ; \
	   else \
	    ( latex book.pamphlet --interaction nonstopmode >${TMP}/trace ; \
	      latex book.pamphlet --interaction nonstopmode >${TMP}/trace ) ; \
	  fi ; \
	  rm book.pamphlet ; \
	  rm book.toc ; \
	  rm book.log ; \
	  rm book.aux )
	@ echo 80 The book is at $(axiom_target_docdir)/book.dvi 

$(addprefix $(axiom_build_bindir)/, notangle noweave):
	@echo 13 making noweb
	@mkdir -p $(axiom_build_nowebdir)
	@mkdir -p ${TMP}
	@mkdir -p $(axiom_build_texdir)
	@(cd $(axiom_build_nowebdir) && \
	  $(TAR) -zxf $(axiom_optional_srcdir)/noweb-2.10a.tgz && \
	  cd $(axiom_build_nowebdir)/src/c && \
	  $(PATCH) < $(axiom_optional_srcdir)/noweb.modules.c.patch && \
	  cd $(axiom_build_nowebdir)/src && \
	  cat Makefile \
	      | sed -e "s|^BIN=.*|BIN=$(axiom_build_bindir)|" \
                    -e "s|^LIB=.*|LIB=$(axiom_build_libdir)|" \
		    -e "s|^MAN=.*|MAN=$(axiom_build_mandir)|" \
                    -e "s|^TEXINPUTS=.*|TEXINPUTS=$(axiom_build_texdir)|" \
		    -e 's/ make / $$\(MAKE\) /' \
	      > Makefile.tmp && mv Makefile.tmp Makefile && \
	  ./awkname $(AWK) && \
	  ${ENV} $(MAKE) BIN=$(axiom_build_bindir) \
                         LIB=$(axiom_build_libdir) \
                         MAN=$(axiom_build_mandir) \
                         TEXINPUTS=$(axiom_build_texdir) \
			 all install > ${TMP}/trace )

install:
	@echo 78 installing Axiom in ${DESTDIR}
	@mkdir -p ${DESTDIR}
	@cp -pr $(builddir)/target ${DESTDIR}
	@echo '#!/bin/sh -' >${COMMAND}
	@echo AXIOM=${DESTDIR}/target/${SYS} >>${COMMAND}
	@echo export AXIOM >>${COMMAND}
	@echo PATH='$${AXIOM}/bin':'$${PATH}' >>${COMMAND}
	@echo export PATH >>${COMMAND}
	@cat $(axiom_src_srcdir)/etc/axiom >>${COMMAND}
	@chmod +x ${COMMAND}
	@echo 79 Axiom installation finished.
	@echo
	@echo Please add $(shell dirname ${COMMAND}) to your PATH variable
	@echo Start Axiom with the command $(shell basename ${COMMAND})
	@echo 


$(src_stamp): $(lsp_stamp)
	cd $(build_srcdir) && $(ENV) $(MAKE)

$(lsp_stamp): $(lib_stamp)
	cd $(build_lspdir) && $(ENV) $(MAKE)

$(lib_stamp): stamp-rootdirs
	cd $(build_libdir) && $(ENV) $(MAKE)

stamp-rootdirs: $(axiom_build_document)
	@echo 11 checking directory structure
	@echo 12 Environment: ${ENV}
	@mkdir -p ${INT}
	@mkdir -p ${OBJ}/${SYS}
	@mkdir -p ${TMP}
	@$(STAMP) stamp-rootdirs


mostlyclean-local:

clean-local: mostlyclean-local
	@rm -rf $(axiom_build_nowebdir)
	@ rm -f stamp-*
	@ rm -rf int
	@ rm -rf obj
	@ rm -f trace

distclean-local: clean-local
	-rm -rf build
	-rm -rf $(axiom_targetdir)
	-rm -f config.status config.log
	-rm -f Makefile

$(top_builddir)/config.status: $(top_srcdir)/configure
	$(SHELL) ./config.status --recheck
