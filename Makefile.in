
## ----------------------------------------
## -- Old-style Axiom makefile variables --
## ----------------------------------------

VERSION="Axiom (build improvements branch) -- 2006-09-12"
SPD=$(shell pwd)
SYS=$(notdir $(AXIOM))
SPAD=${SPD}/mnt/${SYS}
LSP=${SPD}/lsp
GCLVERSION=@axiom_gcl_version@
GCLDIR=${LSP}/${GCLVERSION}
SRC=${SPD}/src
INT=${SPD}/int
OBJ=${SPD}/obj
MNT=${SPD}/mnt
ZIPS=${SPD}/zips
TMP=${OBJ}/tmp
SPADBIN=${MNT}/${SYS}/bin
INC=${SPD}/src/include
CCLBASE=${OBJ}/${SYS}/ccl/ccllisp
DESTDIR=$(prefix)/axiom
COMMAND=${DESTDIR}/mnt/${SYS}/bin/axiom
DAASE = $(axiom_src_datadir)
NOISE="-o ${TMP}/trace"

PLF=@PLF@
CCF=@CCF@
LDF=@LDF@
LISP=@LISP@
GCLOPTS=@GCLOPTS@
SRCDIRS=@SRCDIRS@

PART=	cprogs
SUBPART= everything


ENV= SPAD=${SPAD} SYS=${SYS} SPD=${SPD} LSP=${LSP} GCLDIR=${GCLDIR} \
     SRC=${SRC} INT=${INT} OBJ=${OBJ} MNT=${MNT} ZIPS=${ZIPS} TMP=${TMP} \
     SPADBIN=${SPADBIN} INC=${INC} CCLBASE=${CCLBASE} PART=${PART} \
     SUBPART=${SUBPART} NOISE=${NOISE} GCLVERSION=${GCLVERSION} \
     TANGLE=${TANGLE} VERSION=${VERSION} \
     DOCUMENT=${axiom_build_document} DAASE=$(DAASE) \
     WEAVE=${WEAVE} AXIOM_X11_CFLAGS="${AXIOM_X11_CFLAGS}" \
     AXIOM_X11_LDFLAGS="${AXIOM_X11_LDFLAGS}" \
     PLF="$(PLF)" CCF="$(CCF)" LDF="$(LDF)" LISP=$(LISP) \
	GCLOPTS="$(GCLOPTS)" SRCDIRS="$(SRCDIRS)"


PATH_EXPORTS = AXIOM=@AXIOM@; export AXIOM; PATH=@AXIOM@/bin:$${PATH};

.PHONY: all
all:
	$(PATH_EXPORTS) $(MAKE) do-all

.PHONY: do-all
do-all: @axiom_required_build_utils@ stamp-build-scripts
	@ echo 1 making a ${SYS} system, PART=${PART} SUBPART=${SUBPART}
	@ echo 2 Environment ${ENV}
	@ $(MAKE) stamp-rootdirs
	@ ($(axiom_build_document) --weave --latex \
                                   $(srcdir)/Makefile.pamphlet && \
	   $(mkinstalldirs) ${MNT}/${SYS}/doc/src && \
	   cp Makefile.dvi ${MNT}/${SYS}/doc/root.Makefile.dvi)
	@ ${ENV} $(MAKE) srcsetup lspdir srcdir
	@echo 3 finished system build on `date` | tee >lastBuildDate

.PHONY: start
start:
	$(PATH_EXPORTS) $(MAKE) do-start

.PHONY: do-start
do-start: @axiom_required_build_utils@ stamp-build-scripts

book:
	@ echo 79 building the book as ${MNT}/${SYS}/doc/book.dvi 
	@ mkdir -p ${TMP}
	@ mkdir -p ${MNT}/${SYS}/doc
	@ cp ${SRC}/doc/book.pamphlet ${MNT}/${SYS}/doc
	@ cp -pr ${SRC}/doc/ps ${MNT}/${SYS}/doc
	@ (cd ${MNT}/${SYS}/doc ; \
          if [ .${NOISE} = . ] ; then \
	    ( latex book.pamphlet --interaction nonstopmode ; \
	      latex book.pamphlet --interaction nonstopmode ) ; \
	   else \
	    ( latex book.pamphlet --interaction nonstopmode >${TMP}/trace ; \
	      latex book.pamphlet --interaction nonstopmode >${TMP}/trace ) ; \
	  fi ; \
	  rm book.pamphlet ; \
	  rm book.toc ; \
	  rm book.log ; \
	  rm book.aux )
	@ echo 80 The book is at ${MNT}/${SYS}/doc/book.dvi 

noweb:
	@echo 13 making noweb
	@mkdir -p $(axiom_build_nowebdir)
	@mkdir -p ${TMP}
	@mkdir -p $(axiom_build_texdir)
	@(cd $(axiom_build_nowebdir) && \
	  $(TAR) -zxf $(axiom_optional_srcdir)/noweb-2.10a.tgz && \
	  cd $(axiom_build_nowebdir)/src/c && \
	  $(PATCH) < $(axiom_optional_srcdir)/noweb.modules.c.patch && \
	  cd $(axiom_build_nowebdir)/src && \
	  cat Makefile \
	      | sed -e "s|^BIN=.*|BIN=$(axiom_build_bindir)|" \
                    -e "s|^LIB=.*|LIB=$(axiom_build_libdir)|" \
		    -e "s|^MAN=.*|MAN=$(axiom_build_mandir)|" \
                    -e "s|^TEXINPUTS=.*|TEXINPUTS=$(axiom_build_texdir)|" \
		    -e 's/ make / $$\(MAKE\) /' \
	      > Makefile.tmp && mv Makefile.tmp Makefile && \
	  ./awkname $(AWK) && \
	  ${ENV} $(MAKE) BIN=$(axiom_build_bindir) \
                         LIB=$(axiom_build_libdir) \
                         MAN=$(axiom_build_mandir) \
                         TEXINPUTS=$(axiom_build_texdir) \
			 all install > ${TMP}/trace )
	@ $(STAMP) noweb

nowebclean:
	@echo 14 cleaning $(axiom_build_nowebdir)
	@rm -rf $(axiom_build_nowebdir)
	@rm -f noweb

## We need to have axiom.sty installed before latexing the pamphlets
$(axiom_build_texdir)/axiom.sty: $(axiom_src_srcdir)/doc/axiom.sty.pamphlet
	$(mkinstalldirs) $(axiom_build_texdir) && \
	$(TANGLE) -Raxiom.sty $< > $@

stamp-build-scripts: $(axiom_build_document) \
		     $(axiom_build_texdir)/axiom.sty
	@echo 10 copying $(axiom_src_srcdir)/scripts to $(axiom_top_builddir)/scripts
	@ $(INSTALL) $(axiom_src_srcdir)/scripts/showdvi $(axiom_top_builddir)/scripts
	$ $(STAMP) stamp-build-scripts

install:
	@echo 78 installing Axiom in ${DESTDIR}
	@mkdir -p ${DESTDIR}
	@cp -pr ${MNT} ${DESTDIR}
	@echo '#!/bin/sh -' >${COMMAND}
	@echo AXIOM=${DESTDIR}/mnt/${SYS} >>${COMMAND}
	@echo export AXIOM >>${COMMAND}
	@echo PATH='$${AXIOM}/bin':'$${PATH}' >>${COMMAND}
	@echo export PATH >>${COMMAND}
	@cat ${SRC}/etc/axiom >>${COMMAND}
	@chmod +x ${COMMAND}
	@echo 79 Axiom installation finished.
	@echo
	@echo Please add $(shell dirname ${COMMAND}) to your PATH variable
	@echo Start Axiom with the command $(shell basename ${COMMAND})
	@echo 

srcsetup: stamp-rootdirs
	@echo 18 making ${SPD}/src 
	@( cd src ; ${ENV} ${MAKE} setup )

srcdir: stamp-rootdirs
	@echo 15 making ${SPD}/src 
	@( cd src ; ${ENV} ${MAKE} )

libspadclean:
	@echo 17 cleaning ${OBJ}/${SYS}/lib	
	@rm -rf ${OBJ}/${SYS}/lib	
	@( cd src ; ${ENV} ${MAKE} clean )
	@rm -f ${SPD}/src/Makefile.dvi

lspdir: stamp-rootdirs stamp-build-scripts
	@echo 19 making ${LSP}
	@mkdir -p ${OBJ}/${SYS}/bin
	@mkdir -p ${OBJ}/${SYS}/lsp
	@(cd lsp ; ${ENV} ${MAKE} stamp-gcldir )
#	@(cd lsp ; ${ENV} ${MAKE} ccldir )

lspclean:
	@echo 21 cleaning ${OBJ}/${SYS}/ccl
	@rm -rf ${LSP}/${GCLVERSION}
	@rm -rf ${INT}/ccl
	@rm -rf ${OBJ}/${SYS}/ccl
	@rm -rf ${LSP}/stamp-gcldir
	@rm -f ${LSP}/Makefile.dvi


.PHONY: document
document:
	$(PATH_EXPORTS) $(MAKE) do-document

.PHONY: do-document
do-document: @axiom_build_utils@ stamp-build-scripts
	@ echo 4 making a ${SYS} system, PART=${PART} SUBPART=${SUBPART}
	@ echo 5 Environment ${ENV}
	@mkdir -p ${INT}/doc/lsp
	@mkdir -p ${INT}/doc/src
	@(cd lsp ; ${ENV} ${MAKE} document )
	@(cd src ; ${ENV} ${MAKE} document )
	@echo 6 finished system build on `date` | tee >lastBuildDate

stamp-rootdirs: stamp-build-scripts
	@echo 11 checking directory structure
	@echo 12 Environment: ${ENV}
	@mkdir -p ${INT}
	@mkdir -p ${OBJ}/${SYS}
	@mkdir -p ${TMP}
	@mkdir -p ${MNT}/${SYS}/bin/lib
	@mkdir -p ${MNT}/${SYS}/doc/src
	@$(STAMP) stamp-rootdirs


.PHONY: clean
clean:
	$(PATH_EXPORTS) $(MAKE) do-clean

.PHONY: do-clean
do-clean: 
	@ echo 7 making a ${SYS} system, PART=${PART} SUBPART=${SUBPART}
	@ echo 8 Environment ${ENV}
	@ rm -f lsp/Makefile.dvi
	@ rm -rf lsp/gcl*
	@ rm -f noweb 
	@ rm -f trace
	@ rm -f Makefile.${SYS}
	@ rm -f Makefile.tex
	@ rm -f Makefile.dvi
	@ rm -rf int
	@ rm -rf obj
	@ rm -rf mnt
	@ rm -f stamp-*
	@ for i in `find . -name "*~"` ; do rm -f $$i ; done
	@ for i in `find src -name "Makefile.dvi"` ; do rm -f $$i ; done


distclean: clean
	rm -rf $(axiom_builddir)
	rm -rf $(axiom_targetdir)
	rm -rf $(MNT)
	rm -rf $(OBJ)
	rm -rf $(INT)
